---
import Layout from "../../layouts/Layout.astro";
import ProductDetail from "../../components/catalog/ProductDetail";

const API_BASE_URL = 'http://localhost:5000/api';

// Generate static paths for all products
export async function getStaticPaths() {
  try {
    // Fetch all products from API during build
    const response = await fetch(`${API_BASE_URL}/productos`);
    const productos = await response.json();
    
    return productos.map((producto: any) => ({
      params: { id: producto.id.toString() }
    }));
  } catch (error) {
    console.error('Error fetching products for static paths:', error);
    // Fallback to some default IDs
    return Array.from({ length: 20 }, (_, i) => ({
      params: { id: (i + 1).toString() }
    }));
  }
}

// Get product ID from URL
const { id } = Astro.params;

// Fetch product from API
let product;
try {
  const response = await fetch(`${API_BASE_URL}/productos/${id}`);
  const productData = await response.json();
  
  // Transform API data to component format
  product = {
    id: productData.id,
    nombre: productData.nombre,
    precio: productData.precio,
    descripcion: productData.descripcion || 'Sin descripción',
    categoria: productData.categoria,
    material: productData.material,
    dimensiones: {
      alto: productData.medidas?.alto || 0,
      ancho: productData.medidas?.ancho || 0,
      profundidad: productData.medidas?.profundidad || 0
    },
    colores: ['Estándar'], // TODO: Implement colors in backend
    imagenes: productData.imagenes?.map((img: any) => `http://localhost:5000${img.url}`) || [],
    stock: productData.stock || 0,
    sku: productData.sku,
    imagen_principal: productData.imagen_principal ? `http://localhost:5000${productData.imagen_principal}` : null
  };
  
  // If no images but has imagen_principal, use it
  if (product.imagenes.length === 0 && product.imagen_principal) {
    product.imagenes = [product.imagen_principal];
  }
} catch (error) {
  console.error('Error fetching product:', error);
  // Fallback product
  product = {
    id: parseInt(id || '1'),
    nombre: "Producto no encontrado",
    precio: 0,
    descripcion: "No se pudo cargar la información del producto.",
    categoria: "General",
    material: "N/A",
    dimensiones: { alto: 0, ancho: 0, profundidad: 0 },
    colores: ["N/A"],
    imagenes: [],
    stock: 0,
    sku: "N/A",
  };
}

// Related products (same category)
let relatedProducts: any[] = [];
try {
  const response = await fetch(`${API_BASE_URL}/productos`);
  const allProductos = await response.json();
  relatedProducts = allProductos
    .filter((p: any) => p.categoria === product.categoria && p.id !== product.id)
    .slice(0, 4)
    .map((p: any) => ({
      id: p.id,
      nombre: p.nombre,
      precio: p.precio,
      categoria: p.categoria,
      imagen_principal: p.imagen_principal ? `http://localhost:5000${p.imagen_principal}` : null
    }));
} catch (error) {
  console.error('Error fetching related products:', error);
}
---

<Layout
  title={`${product.nombre} - Muebleria Iris`}
  description={product.descripcion}
>
  <section class="section">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="text-sm text-gray-500 mb-8">
        <a href="/" class="hover:text-primary-600">Inicio</a>
        <span class="mx-2">/</span>
        <a href="/catalogo" class="hover:text-primary-600">Catalogo</a>
        <span class="mx-2">/</span>
        <a
          href={`/catalogo?categoria=${product.categoria?.toLowerCase()}`}
          class="hover:text-primary-600"
        >
          {product.categoria}
        </a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{product.nombre}</span>
      </nav>

      <!-- Product Detail Component (React Island) -->
      <ProductDetail client:load product={product} />

      <!-- Related Products -->
      {
        relatedProducts.length > 0 && (
          <div class="mt-16 pt-16 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900 mb-8">
              Productos Relacionados
            </h2>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
              {relatedProducts.map((related: any) => (
                <a
                  href={`/producto/${related.id}`}
                  class="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all border border-gray-100"
                >
                  <div class="aspect-square bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                    {related.imagen_principal ? (
                      <img 
                        src={related.imagen_principal} 
                        alt={related.nombre}
                        class="w-full h-full object-cover"
                      />
                    ) : (
                      <svg
                        class="w-16 h-16 text-gray-300"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                    )}
                  </div>
                  <div class="p-4">
                    <h3 class="font-semibold text-gray-900 group-hover:text-primary-600 transition-colors">
                      {related.nombre}
                    </h3>
                    <p class="text-primary-600 font-bold mt-1">
                      {new Intl.NumberFormat("es-AR", {
                        style: "currency",
                        currency: "ARS",
                        minimumFractionDigits: 0,
                      }).format(related.precio)}
                    </p>
                  </div>
                </a>
              ))}
            </div>
          </div>
        )
      }
    </div>
  </section>
</Layout>
