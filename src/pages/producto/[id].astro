---
import Layout from "../../layouts/Layout.astro";
import ProductDetail from "../../components/catalog/ProductDetail";
import { API_BASE_URL, getImageUrl } from "../../lib/api";
import { formatPrice } from "../../lib/formatters";
import type { ProductoAPI, ProductoDetalle, ProductoRelacionado } from "../../types/product";

// Generate static paths for all products
export async function getStaticPaths() {
  // Note: For SSG, we need to use the env variable directly since imports may not work at build time
  const apiUrl = import.meta.env.PUBLIC_API_BASE || 'http://localhost:5000';
  try {
    // Fetch all products from API during build
    const response = await fetch(`${apiUrl}/api/productos`);
    const productos: ProductoAPI[] = await response.json();
    
    return productos.map((producto) => ({
      params: { id: producto.id.toString() }
    }));
  } catch {
    // Fallback to some default IDs
    return Array.from({ length: 20 }, (_, i) => ({
      params: { id: (i + 1).toString() }
    }));
  }
}

// Get product ID from URL
const { id } = Astro.params;

// Fetch product from API
let product: ProductoDetalle;
try {
  const response = await fetch(`${API_BASE_URL}/productos/${id}`);
  const productData: ProductoAPI = await response.json();
  
  // Get imagen_principal URL
  const imagenPrincipalUrl = getImageUrl(productData.imagen_principal);
  
  // Transform API data to component format
  const imagenes = productData.imagenes?.map((img) => getImageUrl(img.url)) || [];
  
  // If no images but has imagen_principal, use it
  if (imagenes.length === 0 && imagenPrincipalUrl) {
    imagenes.push(imagenPrincipalUrl);
  }
  
  product = {
    id: productData.id,
    nombre: productData.nombre,
    precio: productData.precio,
    descripcion: productData.descripcion || 'Sin descripción',
    categoria: productData.categoria || 'General',
    material: productData.material || 'N/A',
    dimensiones: {
      alto: productData.medidas?.alto || 0,
      ancho: productData.medidas?.ancho || 0,
      profundidad: productData.medidas?.profundidad || 0
    },
    colores: ['Estándar'], // TODO: Implement colors in backend
    imagenes,
    stock: productData.stock || 0,
    sku: productData.sku || 'N/A',
  };
} catch {
  // Fallback product
  product = {
    id: parseInt(id || '1'),
    nombre: "Producto no encontrado",
    precio: 0,
    descripcion: "No se pudo cargar la información del producto.",
    categoria: "General",
    material: "N/A",
    dimensiones: { alto: 0, ancho: 0, profundidad: 0 },
    colores: ["N/A"],
    imagenes: [],
    stock: 0,
    sku: "N/A",
  };
}

// Related products (same category)
let relatedProducts: ProductoRelacionado[] = [];
try {
  const response = await fetch(`${API_BASE_URL}/productos`);
  const allProductos: ProductoAPI[] = await response.json();
  relatedProducts = allProductos
    .filter((p) => p.categoria === product.categoria && p.id !== product.id)
    .slice(0, 4)
    .map((p) => ({
      id: p.id,
      nombre: p.nombre,
      precio: p.precio,
      categoria: p.categoria,
      imagen_principal: getImageUrl(p.imagen_principal)
    }));
} catch {
  // relatedProducts remains empty
}
---

<Layout
  title={`${product.nombre} - Muebleria Iris`}
  description={product.descripcion}
>
  <section class="section">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="text-sm text-gray-500 mb-8">
        <a href="/" class="hover:text-primary-600">Inicio</a>
        <span class="mx-2">/</span>
        <a href="/catalogo" class="hover:text-primary-600">Catalogo</a>
        <span class="mx-2">/</span>
        <a
          href={`/catalogo?categoria=${product.categoria?.toLowerCase()}`}
          class="hover:text-primary-600"
        >
          {product.categoria}
        </a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{product.nombre}</span>
      </nav>

      <!-- Product Detail Component (React Island) -->
      <ProductDetail client:load product={product} />

      <!-- Related Products -->
      {
        relatedProducts.length > 0 && (
          <div class="mt-16 pt-16 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900 mb-8">
              Productos Relacionados
            </h2>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
              {relatedProducts.map((related) => (
                <a
                  href={`/producto/${related.id}`}
                  class="group bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100"
                >
                  <div class="aspect-square bg-linear-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                    {related.imagen_principal ? (
                      <img 
                        src={related.imagen_principal} 
                        alt={related.nombre}
                        class="w-full h-full object-cover"
                      />
                    ) : (
                      <svg
                        class="w-16 h-16 text-gray-300"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                    )}
                  </div>
                  <div class="p-4">
                    <h3 class="font-semibold text-gray-900">
                      {related.nombre}
                    </h3>
                    <p class="text-primary-600 font-bold mt-1">
                      {formatPrice(related.precio)}
                    </p>
                  </div>
                </a>
              ))}
            </div>
          </div>
        )
      }
    </div>
  </section>
</Layout>
